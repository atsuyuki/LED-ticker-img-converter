<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<title>LED Ticker Uploader (close per send + clear text)</title>
<style>
    :root { --bg:#0f1115; --fg:#e6e8ee; --muted:#9aa3b2; --acc:#4f7cff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#161a22; --border:#232938; }
    html,body{ background:var(--bg); color:var(--fg); font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:0; }
    .wrap{ max-width:880px; margin:28px auto; padding:0 16px; }
    h1{ font-size:18px; margin:6px 0 16px; color:#fff; }
    h2{ font-size:14px; margin:0 0 8px; color:var(--muted); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .btn{ appearance:none; border:1px solid var(--border); background:#1b2230; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .btn.primary{ background:var(--acc); border-color:transparent; }
    input[type="text"]{ background:#0d1119; color:#e8eaef; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    input[type="text"]::placeholder{ color:#7b8394; }
    .hint{ color:var(--muted); font-size:12px; }
    .status{ font-weight:600 } .status.ok{ color:var(--ok) } .status.warn{ color:var(--warn) } .status.err{ color:var(--err) }
    .drop{ border:1px dashed #394255; border-radius:12px; padding:18px; text-align:center; background:#0d1119; color:#c7cfdd; transition:.2s; }
    .drop.drag{ border-color:var(--acc); background:#0b1220; color:#e6edff; }
    #preview{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-size:8px; line-height:.65em; letter-spacing:.10em; white-space:nowrap; margin:8px 0 12px; }
    .ON{ color:rgb(255,68,68); text-shadow:0 0 10px rgba(255,68,68,.55); }
    .OFF{ color:rgba(255,68,68,0); }
    pre#code{ background:#0b0f16; border:1px solid var(--border); border-radius:10px; padding:.6rem .8rem; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:10px; line-height:1.2; max-height:160px; overflow:auto; color:#dfe4ee; margin:8px 0 0; }
    #log{ background:#0b0f16; color:#a7ffb2; padding:.6rem .8rem; height:140px; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    .kbd{ font-family: ui-monospace,Menlo,monospace; background:#0d1119; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:#cbd5e1; }
    /* Step1 サンプル表示 */
    figure.sample{ margin:8px 0 0; }
    figure.sample img{ display:block; width:70%; height:auto; cursor:pointer; }
    figure.sample .hint{ margin-top:6px; }
    /* 画像プレビュー領域: 背景を白、文字基準の高さ(lh)で8行ぶん */
    #imagePreview {
      background:#ffffff;
      font-size: 8px;      /* #preview と揃える */
      line-height: .7em;   /* #preview と揃える */
      height: calc(8 * 1lh); /* 8行ぶんの高さ */
      /* センタリングしない（通常のフロー配置） */
    }
    /* 画像は高さを枠いっぱい（8lh）に、幅はアスペクト維持で自動 */
    #previewImage {
      height: 100% !important;
      width: auto !important;
      max-height: none !important;
      max-width: none !important;
      display: block;
      /* アンチエイリアスを無効化（最近傍表示） */
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
</style>

<div class="wrap">
    <h1>LED Ticker Uploader</h1>

    <!-- ステップ 1: 画像を作成する -->
    <div class="card">
        <h2>① 画像を作成する</h2>
<div class="hint">
    LEDティッカーに表示したい画像をご用意ください（Webで使用できる形式なら何でもOK：JPG/PNG/GIF/WebP/SVG 等）。
    <ul>
        <li>色は白黒（黒の部分が光ります）</li>
        <li>サイズと縦横比は自由ですが、推奨は縦8ドットのピクセルアートです。</li>
        <li>横幅が長くなるとスクロールが遅くなります。</li>
    </ul>
</div>
<figure class="sample">
  <figcaption class="hint">サンプル（クリックで読み込み）</figcaption>
  <img class="base64-image" src="data:image/png;base64,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"/>
</figure>
    </div>

    <!-- ステップ 2: 画像を開く（ファイル選択） -->
    <div class="card">
        <h2>② 画像を開く（ファイル選択）</h2>
        <div class="drop" id="drop">
            ここに画像をドラッグ＆ドロップ<br><span class="hint">または</span><br>
            <button class="btn" id="pickBtn">画像を選択</button>
            <input type="file" id="file_input" accept="image/*" style="display:none">
            <div class="hint" id="pickedHint" style="margin-top:8px; display:none;"></div>
        </div>
    </div>

    <!-- ステップ 3: プレビュー & テキスト確認 -->
    <div class="card">
        <h2>③ プレビュー & テキスト確認</h2>
        <div id="imagePreview" style="margin-bottom: 12px; text-align: center;">
            <img id="previewImage" style="max-width: 100%; max-height: 200px; display: none;" alt="プレビュー画像">
        </div>
        <div id="preview"></div>
        <pre id="code"></pre>
        <div class="hint">点灯=1 / 消灯=0</div>
    </div>

    <!-- ステップ 4: 送信 / ダウンロード -->
    <div class="card">
        <h2>④ 送信 / ダウンロード</h2>
        <div class="hint" style="margin:6px 0 10px;">
            ※ 送信前に、本体の <strong>NEXT</strong> と <strong>BACK</strong> を同時に押して
            <strong>「WAIT」表示</strong>にしてください。
        </div>
        <div class="row">
            <button class="btn primary" id="btnSend" disabled>デバイスに送信</button>
            <button class="btn" id="btnDownload" disabled>ダウンロード</button>
          </div>
        </div>
        
    <!-- ステップ 5: デバイス応答 -->
        <div class="card">
          <h2>デバイス応答</h2>
          <span class="status" id="status">Not connected</span>
        <pre id="log"></pre>
    </div>
</div>

<input type="hidden" id="content">
<canvas id="canvas" style="display:none;"></canvas>

<script>
const $ = (id)=>document.getElementById(id);
const setStatus = (s, cls='')=>{ const el=$('status'); el.textContent=s; el.className='status '+cls; };
const log = (s)=>{ const el=$('log'); el.textContent += s; el.scrollTop = el.scrollHeight; };
// 文字列をダウンロード保存
function downloadTextFile(filename, text){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// テキスト確認欄（pre#code）をデータ未設定時に8行の空行でプレースホルダー表示
function setCodePlaceholder(){
  const lines = 8;
  $('code').textContent = "\n".repeat(lines);
}

/* ---------- 入力（クリック/ドロップ） ---------- */
$('pickBtn').addEventListener('click', ()=>$('file_input').click());
const drop = $('drop');
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleImageFile(f); });
$('file_input').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleImageFile(f); });

function handleImageFile(file) {
  if (!file) return;
  $('pickedHint').style.display = 'block';
  $('pickedHint').textContent = `選択中: ${file.name} (${Math.round(file.size / 1024)} KB)`;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      // 元の画像をプレビュー
      const previewImage = $('previewImage');
      previewImage.src = e.target.result;
      previewImage.style.display = 'block';

      // LED用の変換処理
      convertImage(img, file.name);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// サンプル画像（base64埋め込み）をクリックで読み込み・変換
(() => {
  const sample = document.querySelector('.base64-image');
  if (!sample) return;
  sample.style.cursor = 'pointer';
  sample.title = 'クリックでサンプルを読み込み';
  sample.addEventListener('click', () => {
    const prev = $('previewImage');
    prev.src = sample.src;
    prev.style.display = 'block';
    if (sample.complete) {
      convertImage(sample, 'sample.png');
    } else {
      sample.addEventListener('load', () => convertImage(sample, 'sample.png'), { once: true });
    }
  });
})();

/* ---------- 画像→0/1（縦横比維持H=8） ---------- */
function convertImage(img, origName){
  const targetH = 8;
  const targetW = Math.min(256, Math.max(1, Math.round(img.naturalWidth*(targetH/img.naturalHeight))));

  const srcW = img.naturalWidth, srcH = img.naturalHeight;
  const c = document.createElement('canvas'); c.width=srcW; c.height=srcH;
  const ctx = c.getContext('2d', {willReadFrequently:true}); ctx.drawImage(img,0,0);
  const src = ctx.getImageData(0,0,srcW,srcH).data;

  const scale = Math.min(targetW/srcW, targetH/srcH);
  const fitW = srcW*scale, fitH = srcH*scale;
  const offX = (targetW - fitW)/2, offY = (targetH - fitH)/2;

  const rows=[];
  for(let ty=0; ty<targetH; ty++){
    let line='';
    for(let tx=0; tx<targetW; tx++){
      // 中心座標で内外判定（浮動小数の微小ズレで最上段が除外されるのを防止）
      const cx = tx + 0.5, cy = ty + 0.5;
      if(cx<=offX || cx>offX+fitW || cy<=offY || cy>offY+fitH){ line+='0'; continue; }
      const sx = Math.min(srcW-1, Math.max(0, Math.floor(((tx-offX)+0.5)/scale)));
      const sy = Math.min(srcH-1, Math.max(0, Math.floor(((ty-offY)+0.5)/scale)));
      const i = (sy*srcW+sx)*4;
      const r=src[i], g=src[i+1], b=src[i+2], a=src[i+3];
      const threshold = 512; // RGBの合計がこの値以下なら「黒」と判定
      const bit = Number((r + g + b <= threshold) && a > 1); // 黒=1
      line += bit ? '1' : '0';
    }
    rows.push(line);
  }

  const text = rows.join('\n');
  $('code').textContent = text;     // 表示
  $('content').value   = text;      // 送信用
  $('preview').innerHTML = rows.map(line => line.replace(/0/g,'<span class="OFF">●</span>').replace(/1/g,'<span class="ON">●</span>')).join('<br>');

  const stem = (origName||'').replace(/\.[^.]+$/, '') || '0000';
  // ダウンロード用の元名（不正文字置換＋.txt）を保持
  window.lastDownloadName = sanitizeFilename(`${stem}.txt`);

  $('btnSend').disabled = false;
  $('btnDownload').disabled = false;
}

/* ---------- Utils ---------- */
function base64FromBytes(bytes){ let bin=''; const CH=0x8000; for(let i=0;i<bytes.length;i+=CH) bin += String.fromCharCode.apply(null, bytes.subarray(i,i+CH)); return btoa(bin); }
function sanitizeFilename(name){
  let n=(name||'').trim()
    .replace(/[\\\/:*?"<>|]/g,'-') // 不正な文字をハイフンに置換
    .replace(/\s+/g, '-');         // スペースをハイフンに置換
  if(n.startsWith('.')) n='0'+n;   // ファイル名がドットで始まる場合の対応
  if(!n) n='0000.txt';             // 空の場合のデフォルト名
  if(!/\.[^.]+$/.test(n)) n+='.txt'; // 拡張子がない場合の対応
  return n;
}
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

/* ---------- 応答待ち（改行なし/切断でも検出） ---------- */
async function readDeviceResponse(reader, timeoutMs=10000){
  const started = Date.now();
  let buf=''; const hasOK=()=>/OK/.test(buf); const hasERR=()=>/ERR/.test(buf);
  while(Date.now()-started < timeoutMs){
    try{
      const {value, done} = await reader.read();
      if(value){
        const s=new TextDecoder().decode(value);
        buf+=s; log(s);
        if(hasOK())  return {status:'OK', raw:buf};
        if(hasERR()) return {status:'ERR',raw:buf};
      }
      if(done){
        if(hasOK())  return {status:'OK', raw:buf};
        if(hasERR()) return {status:'ERR',raw:buf};
        break;
      }
    }catch{
      if(hasOK())  return {status:'OK', raw:buf};
      if(hasERR()) return {status:'ERR',raw:buf};
      break;
    }
  }
  return {status:'TIMEOUT', raw:buf};
}

/* ---------- 送信（毎回 接続→応答→クローズ / 押下でテキストクリア） ---------- */
$('btnSend').addEventListener('click', sendNow);
// ダウンロード
$('btnDownload').addEventListener('click', ()=>{
  const content = $('content').value ?? '';
  if(!content){
    alert('ダウンロードできるデータがありません。画像を選んで変換してください。');
    return;
  }
  const name = window.lastDownloadName || '0000.txt';
  downloadTextFile(name, content);
});

async function sendNow() {
  const content = $('content').value ?? '';
  if (!content) {
    alert('データがありません。画像を選んで変換してください。');
    return;
  }

  // 押下時にUIの表示を先にクリア（誤連打防止 / 結果が見やすい）
  const prevText = content;
  setCodePlaceholder();
  $('preview').innerHTML = '';
  $('content').value = '';
  // 画像プレビューもクリア
  (function(){
    const img = $('previewImage');
    if (img){ img.src = ''; img.style.display = 'none'; }
  })();
  $('btnSend').disabled = true;
  $('btnDownload').disabled = true;

  let port = null,
    writer = null,
    reader = null;
  try {
    if (!('serial' in navigator)) {
      alert('このブラウザはWeb Serialに非対応です。');
      return;
    }
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    setStatus('Connected', 'ok');

    const path = `imgs/0000.txt`;
    const bytes = new TextEncoder().encode(prevText);
    const size = bytes.length;
    const b64 = base64FromBytes(bytes);
    const chunkLen = 240;
    const lines = [];
    for (let i = 0; i < b64.length; i += chunkLen) lines.push(b64.slice(i, i + chunkLen));

    const writeLine = async (s) => {
      const data = new TextEncoder().encode(s + '\n');
      await writer.write(data);
    };

    setStatus('Sending…', 'warn');
    await writeLine(`PUT ${path} ${size}`);
    for (const ln of lines) {
      await writeLine(ln);
      await sleep(2);
    }
    await writeLine('.');
    setStatus('Sent. Waiting for OK…', 'warn');

    const result = await readDeviceResponse(reader, 8000);
    await sleep(100); // 余韻

    if (result.status === 'OK') {
      setStatus('Uploaded (OK)', 'ok');
    } else if (result.status === 'ERR') {
      setStatus('Device ERR', 'err');
    } else {
      setStatus('No response (timeout)', 'err');
    }
  } catch (e) {
    // 失敗したら元に戻して再送できるようにする
    $('code').textContent = prevText;
    $('content').value = prevText;
    $('btnSend').disabled = false;
    setStatus('Write/Conn error', 'err');
    console.error(e);
  } finally {
    try {
      if (writer) writer.releaseLock();
    } catch {}
    try {
      if (reader) {
        await reader.cancel();
        reader.releaseLock();
      }
    } catch {}
    try {
      if (port) await port.close();
    } catch {}
    setStatus('Port closed', '');
  }
}

// 初期表示時に空なら8行プレースホルダーを表示
if(!$('code').textContent){ setCodePlaceholder(); }
</script>
</html>
