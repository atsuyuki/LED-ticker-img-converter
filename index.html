<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<title>LED Ticker Uploader (close per send + clear text)</title>
<style>
    :root { --bg:#0f1115; --fg:#e6e8ee; --muted:#9aa3b2; --acc:#4f7cff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#161a22; --border:#232938; }
    html,body{ background:var(--bg); color:var(--fg); font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:0; }
    .wrap{ max-width:880px; margin:28px auto; padding:0 16px; }
    h1{ font-size:18px; margin:6px 0 16px; color:#fff; }
    h2{ font-size:14px; margin:0 0 8px; color:var(--muted); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .btn{ appearance:none; border:1px solid var(--border); background:#1b2230; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .btn.primary{ background:var(--acc); border-color:transparent; }
    input[type="text"]{ background:#0d1119; color:#e8eaef; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    input[type="text"]::placeholder{ color:#7b8394; }
    .hint{ color:var(--muted); font-size:12px; }
    .status{ font-weight:600 } .status.ok{ color:var(--ok) } .status.warn{ color:var(--warn) } .status.err{ color:var(--err) }
    .drop{ border:1px dashed #394255; border-radius:12px; padding:18px; text-align:center; background:#0d1119; color:#c7cfdd; transition:.2s; }
    .drop.drag{ border-color:var(--acc); background:#0b1220; color:#e6edff; }
    #preview{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-size:8px; line-height:.7em; letter-spacing:-.15em; white-space:nowrap; margin:8px 0 12px; }
    .ON{ color:rgb(255,68,68); text-shadow:0 0 10px rgba(255,68,68,.55); }
    .OFF{ color:rgba(255,68,68,0); }
    pre#code{ background:#0b0f16; border:1px solid var(--border); border-radius:10px; padding:.6rem .8rem; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:10px; line-height:1.2; max-height:160px; overflow:auto; color:#dfe4ee; margin:8px 0 0; }
    #log{ background:#0b0f16; color:#a7ffb2; padding:.6rem .8rem; height:140px; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    .kbd{ font-family: ui-monospace,Menlo,monospace; background:#0d1119; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:#cbd5e1; }
</style>

<div class="wrap">
    <h1>LED Ticker Uploader</h1>

    <div class="card">
        <h2>① 画像を選ぶ</h2>
        <div class="drop" id="drop">
            ここに画像をドラッグ＆ドロップ<br><span class="hint">または</span><br>
            <button class="btn" id="pickBtn">画像を選択</button>
            <input type="file" id="file_input" accept="image/*" style="display:none">
            <div class="hint" id="pickedHint" style="margin-top:8px; display:none;"></div>
        </div>
    </div>

    <div class="card">
        <h2>② プレビュー & テキスト確認</h2>
        <div id="preview"></div>
        <pre id="code"></pre>
        <div class="hint">高さ8行・縦横比維持。点灯=1 / 消灯=0</div>
    </div>

    <div class="card">
        <h2>③ ファイル名を決める</h2>
        <div class="row">
            <input id="fname" type="text" placeholder="例: hello.txt" value="0000.txt" style="min-width:220px">
            <span class="hint">不正な文字は自動で置換されます</span>
        </div>
    </div>

<!-- STEP 4: 送信 -->
<div class="card">
  <h2>④ 送信</h2>
  <div class="hint" style="margin:6px 0 10px;">
    ※ 送信前に、本体の <strong>NEXT</strong> と <strong>BACK</strong> を同時に押して
    <strong>「WAIT」表示</strong>にしてください。
  </div>
  <div class="row">
    <button class="btn primary" id="btnSend" disabled>送信（Enter）</button>
    <button class="btn" id="btnReset">リセット</button>
    <span class="status" id="status">Not connected</span>
  </div>
</div>

    <div class="card">
        <h2>デバイス応答</h2>
        <pre id="log"></pre>
    </div>
</div>

<input type="hidden" id="content">
<canvas id="canvas" style="display:none;"></canvas>

<script>
const $ = (id)=>document.getElementById(id);
const setStatus = (s, cls='')=>{ const el=$('status'); el.textContent=s; el.className='status '+cls; };
const log = (s)=>{ const el=$('log'); el.textContent += s; el.scrollTop = el.scrollHeight; };

/* ---------- 入力（クリック/ドロップ） ---------- */
$('pickBtn').addEventListener('click', ()=>$('file_input').click());
const drop = $('drop');
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleImageFile(f); });
$('file_input').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleImageFile(f); });

function handleImageFile(file){
  if(!file) return;
  $('pickedHint').style.display='block';
  $('pickedHint').textContent = `選択中: ${file.name} (${Math.round(file.size/1024)} KB)`;
  const reader = new FileReader();
  reader.onload = e => { const img = new Image(); img.onload = ()=>convertImage(img, file.name); img.src = e.target.result; };
  reader.readAsDataURL(file);
}

/* ---------- 画像→0/1（縦横比維持H=8） ---------- */
function convertImage(img, origName){
  const targetH = 8;
  const targetW = Math.min(256, Math.max(1, Math.round(img.naturalWidth*(targetH/img.naturalHeight))));

  const srcW = img.naturalWidth, srcH = img.naturalHeight;
  const c = document.createElement('canvas'); c.width=srcW; c.height=srcH;
  const ctx = c.getContext('2d', {willReadFrequently:true}); ctx.drawImage(img,0,0);
  const src = ctx.getImageData(0,0,srcW,srcH).data;

  const scale = Math.min(targetW/srcW, targetH/srcH);
  const fitW = srcW*scale, fitH = srcH*scale;
  const offX = (targetW - fitW)/2, offY = (targetH - fitH)/2;

  const rows=[];
  for(let ty=0; ty<targetH; ty++){
    let line='';
    for(let tx=0; tx<targetW; tx++){
      if(tx<offX || tx>=offX+fitW || ty<offY || ty>=offY+fitH){ line+='0'; continue; }
      const sx = Math.min(srcW-1, Math.max(0, Math.floor(((tx-offX)+0.5)/scale)));
      const sy = Math.min(srcH-1, Math.max(0, Math.floor(((ty-offY)+0.5)/scale)));
      const i = (sy*srcW+sx)*4;
      const r=src[i], g=src[i+1], b=src[i+2], a=src[i+3];
      const bit = Number(!(r>1 || g>1 || b>1) && a>1); // 黒=1
      line += bit ? '1' : '0';
    }
    rows.push(line);
  }

  const text = rows.join('\n');
  $('code').textContent = text;     // 表示
  $('content').value   = text;      // 送信用
  $('preview').innerHTML = rows.map(line => line.replace(/0/g,'<span class="OFF">●</span>').replace(/1/g,'<span class="ON">●</span>')).join('<br>');

  const stem = (origName||'').replace(/\.[^.]+$/, '') || '0000';
  if(!$('fname').dataset.userEdited){ $('fname').value = `${stem}.txt`; }

  $('btnSend').disabled = false;
}
$('fname').addEventListener('input', ()=>{ $('fname').dataset.userEdited='1'; });

/* ---------- Utils ---------- */
function base64FromBytes(bytes){ let bin=''; const CH=0x8000; for(let i=0;i<bytes.length;i+=CH) bin += String.fromCharCode.apply(null, bytes.subarray(i,i+CH)); return btoa(bin); }
function sanitizeFilename(name){
  let n=(name||'').trim().replace(/[\\\/:*?"<>|]/g,'-');
  if(n.startsWith('.')) n='0'+n;
  if(!n) n='0000.txt';
  if(!/\.[^.]+$/.test(n)) n+='.txt';
  return n;
}
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

/* ---------- 応答待ち（改行なし/切断でも検出） ---------- */
async function readDeviceResponse(reader, timeoutMs=10000){
  const started = Date.now();
  let buf=''; const hasOK=()=>/OK/.test(buf); const hasERR=()=>/ERR/.test(buf);
  while(Date.now()-started < timeoutMs){
    try{
      const {value, done} = await reader.read();
      if(value){
        const s=new TextDecoder().decode(value);
        buf+=s; log(s);
        if(hasOK())  return {status:'OK', raw:buf};
        if(hasERR()) return {status:'ERR',raw:buf};
      }
      if(done){
        if(hasOK())  return {status:'OK', raw:buf};
        if(hasERR()) return {status:'ERR',raw:buf};
        break;
      }
    }catch{
      if(hasOK())  return {status:'OK', raw:buf};
      if(hasERR()) return {status:'ERR',raw:buf};
      break;
    }
  }
  return {status:'TIMEOUT', raw:buf};
}

/* ---------- 送信（毎回 接続→応答→クローズ / 押下でテキストクリア） ---------- */
document.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.metaKey && !e.ctrlKey && !$('btnSend').disabled){ e.preventDefault(); sendNow(); } });
$('btnSend').addEventListener('click', sendNow);

async function sendNow(){
  const content = $('content').value ?? '';
  if(!content){ alert('データがありません。画像を選んで変換してください。'); return; }

  // 押下時にUIの表示を先にクリア（誤連打防止 / 結果が見やすい）
  const prevText = content;
  $('code').textContent = '';
  $('preview').innerHTML = '';
  $('content').value = '';
  $('btnSend').disabled = true;

  let port=null, writer=null, reader=null;
  try{
    if(!('serial' in navigator)){ alert('このブラウザはWeb Serialに非対応です。'); return; }
    port = await navigator.serial.requestPort();
    await port.open({ baudRate:115200 });
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    setStatus('Connected','ok');

    const path  = `imgs/${sanitizeFilename($('fname').value)}`;
    const bytes = new TextEncoder().encode(prevText);
    const size  = bytes.length;
    const b64   = base64FromBytes(bytes);
    const chunkLen = 240;
    const lines=[]; for(let i=0;i<b64.length;i+=chunkLen) lines.push(b64.slice(i,i+chunkLen));

    const writeLine = async (s)=>{ const data=new TextEncoder().encode(s+'\n'); await writer.write(data); };

    setStatus('Sending…','warn');
    await writeLine(`PUT ${path} ${size}`);
    for(const ln of lines){ await writeLine(ln); await sleep(2); }
    await writeLine('.');
    setStatus('Sent. Waiting for OK…','warn');

    const result = await readDeviceResponse(reader, 8000);
    await sleep(100); // 余韻

    if(result.status==='OK'){ setStatus('Uploaded (OK)','ok'); }
    else if(result.status==='ERR'){ setStatus('Device ERR','err'); }
    else { setStatus('No response (timeout)','err'); }

  } catch(e){
    // 失敗したら元に戻して再送できるようにする
    $('code').textContent = prevText;
    $('content').value   = prevText;
    $('btnSend').disabled = false;
    setStatus('Write/Conn error','err'); console.error(e);
  } finally {
    try{ if(writer) writer.releaseLock(); }catch{}
    try{ if(reader){ await reader.cancel(); reader.releaseLock(); } }catch{}
    try{ if(port) await port.close(); }catch{}
    setStatus('Port closed','');
  }
}

// リセット：ページをリロードするだけ
$('btnReset').addEventListener('click', () => {
  location.reload();
});
</script>
</html>
